##### GPS ###
# This script tests RX message handling and verifies that the antenna functions properly.
# It does not test for detecting a valid GPS signal.

fn Rset()
    cmd("reset(0)") # reset my client
    reset(0) # reset myself
fend

fn Test()    
    println("Starting test...")
    Wait(1)
    dlmode(2,0)
    Wait(10)
    
    c = 0
    p = 0
    
    while (1)
        r = SerB2R()
        if(r = 0)
            println("Wait for data comming...")
            while (SerB2R() = 0)
                wait(2)
            wend
        end
 
        if r > 0
            for i = 0 to r
 
                b = SerRd() 
 
                if b = '$'
                    c = 0
                end
 
                b7[c] = b 
 
                c = c + 1
 
                if b = 10 # \n
                    b7[c] = 0
 
                    if b7[0] = '$' && b7[1]= 'G' && b7[2]= 'P' && b7[3]= 'T' && b7[4]= 'X'&& b7[5]= 'T'
                        p = 1
                        
                        SerDisc() # No need
                    end
 
                    #println("Raw:", b7)
                    break
 
                end
            next
        end
 
        if p = 1 # parse
            println("***********************************")
 
            p = 0 # reset flag
            for x = 6 to len(b7)
                if b7[x] = 'A' && b7[x+1] = 'N' && b7[x+8] = 'O' && b7[x+9] = 'K'
                    println("Antenna OK")
                    break
                end
                
            next
 
        end
 
        wait(1)
 
    wend
fend